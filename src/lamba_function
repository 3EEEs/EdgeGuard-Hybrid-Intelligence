//Cpoy of function currently in AWS Lamba

import json
import boto3
import uuid
import urllib.parse
from datetime import datetime
from decimal import Decimal

# Connect to AWS services
s3 = boto3.client('s3')
rekognition = boto3.client('rekognition')
dynamodb = boto3.resource('dynamodb')

# Lowercase 'g' to match your DynamoDB table
table = dynamodb.Table('Edgeguard_Events') 

def lambda_handler(event, context):
    # 1. Get the image info from the upload event
    bucket = event['Records'][0]['s3']['bucket']['name']
    key = urllib.parse.unquote_plus(event['Records'][0]['s3']['object']['key'], encoding='utf-8')
    
    try:
        print(f"Processing image: {key} from bucket: {bucket}")
        
        # 2. Send image to Amazon Rekognition
        response = rekognition.detect_labels(
            Image={'S3Object': {'Bucket': bucket, 'Name': key}},
            MaxLabels=10,
            MinConfidence=70
        )
        
        # 3. Simplify the data and convert floats to Decimals
        detected_labels = []
        for label in response['Labels']:
            detected_labels.append({
                'Name': label['Name'],
                'Confidence': Decimal(str(label['Confidence']))
            })
            
        print(f"Found labels: {detected_labels}")
        
        # 4. Save to DynamoDB
        event_id = str(uuid.uuid4())
        timestamp = datetime.now().isoformat()
        
        table.put_item(
            Item={
                'EventID': event_id,
                'Timestamp': timestamp,
                'S3_URL': f"s3://{bucket}/{key}",
                'Detected_Labels': detected_labels
            }
        )
        
        return {'statusCode': 200, 'body': json.dumps('Success')}
        
    except Exception as e:
        print(e)
        raise e
